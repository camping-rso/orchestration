---
- hosts: all
  tasks:
    - name: Install kubectl
      shell: "az aks install-cli --install-location=./kubectl"

    - name: Connect to cluster using kubectl
      shell: "az aks get-credentials --resource-group {{ resource_group_name }} --name {{ aks_name }}"

    - name: Create a namespace for ingress resources
      shell: "./kubectl create namespace ingress-camping"

    - name: Install helm
      shell: "curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 && chmod 700 get_helm.sh && ./get_helm.sh"

#    - name: Install helm
#      shell: "wget https://get.helm.sh/helm-v3.4.2-linux-amd64.tar.gz && tar -zxvf helm-v3.4.2-linux-amd64.tar.gz && mv linux-amd64/helm ./helm"

    - name: Add the ingress-nginx repository
      shell: "helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx"

    - name: Use Helm to deploy an NGINX ingress controller
      shell: 'helm install nginx-ingress ingress-nginx/ingress-nginx
                   --namespace ingress-camping
                   --set controller.replicaCount=1
                   --set controller.nodeSelector."beta\.kubernetes\.io/os"=linux
                   --set defaultBackend.nodeSelector."beta\.kubernetes\.io/os"=linux
                   --set controller.admissionWebhooks.patch.nodeSelector."beta\.kubernetes\.io/os"=linux'

    - name: Create Kubernetes deployment and service
      shell: "./kubectl apply -f ingress.yml"
...


  sudo helm install nginx-ingress ingress-nginx/ingress-nginx --namespace ingress-camping --set controller.replicaCount=1 --set controller.nodeSelector."beta\.kubernetes\.io/os"=linux --set defaultBackend.nodeSelector."beta\.kubernetes\.io/os"=linux --set controller.admissionWebhooks.patch.nodeSelector."beta\.kubernetes\.io/os"=linux
